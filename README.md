# ball-detection-sports1m
## Tasks
1.  Generate pseudo-annotations for video data.
2. Build an object detection pipeline that can train on your annotations.
3. Create an evaluation procedure with visualizations of predictions and annotations
4. Design a process to iteratively improve your dataset. 
<br><br>
Dataset: Sports-1M

## Setup Requirements
```pip install -r requirements.txt```

## Data processing pipeline steps
### 1. Download Youtube videos from links listed in the Sports-1M dataset repository

```youtube_download.py```
- Take video links from original/train_partition.txt
- mapping the sports class number label with labels.txt
- Only use sports that involves a ball, listed in ```TARGET_LABEL_NAME```
- Using yt-dlp module
- Videos are saved by class
- Set to download a total of 300 videos

### 2. Extract frames from videos

```extract_frames_threads.py```

now set to 250 frames of each video, can be adjusted

### 3. Annotate the ball
```auto_annotate.py```
- Auto annotating balls in the extracted frames with a pre-trained YOLOv11m model on sports ball class (class 32).
- Ultralytics package is used.
- Annotations are only saved where more than 1 ball is detected
- Annotations are saved in normalised COCO bounding box format ```<class> <x_mid> <y_mid> <width> <height>```
- Alternative: Manually annotate or adjust a small dataset with tools like LabelImg or Roboflow
#### How to improve annotations?
Train a model with the initial annotations. Run ```auto_annotate.py``` again with the fine-tuned model. <br>
Make a copy of the initial annoatations as a checkpoint for the next steps


### 4. Organise files into training folders
```train_val_split_binary.py```

Copy files into folders to be read with the training function in Ultralytics package.

### 5. Updating class ID on annotation file
```update_class_id_binary.py``` 

Changing class ID of the annotations from 32 of the COCO dataset to 0 for a single class detection (Coarse class-count). <br>
(Alternative: to detect different balls (fine class-count), use ```update_class_id.py```, which redistributes class ID according to list of sports chosen)



## Training pipeline
```train.py```
- Loads a YOLOv8m pre-trained model for fine-tuning. (Other models can also be used. Model chosen now at computation limitations)
- Datasets and class configurations are stored in ```dataset_binary.yaml```
- training metrics saved in ```./runs/detect/train```


## Evaluation
```eval.py```
- Datasets and class configurations are stored in ```dataset_binary.yaml```
  - evaluated on test set
- Evaluation results are automatically generated by the eval() function of the Ultralytics package
  - Saved in ```./runs/detect/val```

## Visualisation
```visualise_video.py```
Saves an annotated video randomly picked from the downloaded video dataset


## Improving dataset
- Run steps from 3. Annotate the ball again with the fine-tuned model
- Manually adjust some annotations
- Explore data augmentation, Slicing Aided Hyper Inference (SAHI)

## Summary of steps and Scripts
| **Step**                                      | **Script Used**               | **Description**                                                                                          |
|-----------------------------------------------|--------------------------------|----------------------------------------------------------------------------------------------------------|
| 1. Download Videos                            | `youtube_download.py`         | Downloads YouTube videos listed in the Sports-1M dataset. Filters sports involving balls using `TARGET_LABEL_NAME`. |
| 2. Extract Frames from Videos                 | `extract_frames_threads.py`   | Extracts 250 frames per video (adjustable).                                                              |
| 3. Annotate the Ball                          | `auto_annotate.py`            | Auto-annotates frames using YOLOv11m on class 32 (sports ball). Saves annotations in COCO format.        |
| 4. Organise Training Folders                  | `train_val_split_binary.py`   | Splits frames and annotations into training and validation folders for YOLO training.                   |
| 5. Update Class IDs in Annotations            | `update_class_id_binary.py`   | Converts COCO class ID 32 to ID 0 for single-class detection.                                            |
| 6. Train Object Detection Model               | `train.py`                    | Fine-tunes a YOLOv8m pre-trained model using the prepared dataset and configuration files.               |
| 7. Evaluate Model                             | `eval.py`                     | Evaluates the trained model on a test set. Results generated by Ultralytics package functions.           |
| 8. Visualisation                              | `visualise_video.py`          | Saves an annotated video randomly picked from the downloaded video dataset.                              |
| 9. Improve Dataset                            | `auto_annotate.py` (re-run)   | Re-annotates data with the fine-tuned model to enhance annotations.                                      |



## Challenges
- Loading and filtering the dataset
  - The dataset .txt file is huge to read all into memory
- Videos from the dataset is no longer available on YouTube, less dataset than expected to download
- Video quality is very low, some videos are from more than 10 years ago with low resolution.
  - main frames return with no detection on auto annotation with the pre-trained model
- Attempted to detect ball by different sports (fine class-count), but the dataset is very biased due to the reasons above
- Other lookalike items such as round logos are also detected as ball